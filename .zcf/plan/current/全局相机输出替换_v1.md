## 上下文

- 目标：在 `Magisk + LSPosed` 环境下做系统级（Hook）方案，实现相机输出“最终文件替换”，用于自研 App 端到端自动化测试。
- 设备：Redmi 5，MIUI 10.3 稳定版（预期 Android 8.1）。
- 约束：允许 Root；接受 `Magisk/LSPosed`；优先实现 `Camera1`（`android.hardware.Camera`），`Camera2` 作为后续增强。

## 交付物（v1）

- 一个可编译安装的 LSPosed 模块 APK（含设置界面）
- 默认白名单模式（仅对指定包名生效），可切换全局模式
- 拍照：Hook `android.hardware.Camera.takePicture(...)`，替换 `PictureCallback` 的 JPEG 字节
- 录视频：Hook `android.media.MediaRecorder.setOutputFile(...)` 记录输出路径，Hook `MediaRecorder.stop()` 后覆盖最终文件
- 配置：默认读取 `/sdcard/VirtualCam/config.json`；素材默认 `/sdcard/VirtualCam/photo.jpg`、`/sdcard/VirtualCam/video.mp4`

## 验收标准（v1）

- 在白名单 App 内拍照：保存出的图片内容与 `photo.jpg` 一致（文件大小/hash 可对比）
- 在白名单 App 内录制：停止录制后生成的视频文件被 `video.mp4` 覆盖
- 缺失配置/素材时不影响原 App 正常拍照/录制（仅记录日志并降级为不替换）

## 实施步骤（原子操作）

1. 初始化 Android/Gradle 工程与基础依赖（AppCompat + Xposed API compileOnly）。
2. 增加 Xposed 模块声明（`assets/xposed_init`、Manifest meta-data、入口类）。
3. 实现配置读取与容错（JSON + 缓存），以及白名单/全局策略。
4. 实现 Camera1 Hook：包装 JPEG `PictureCallback` 并按配置替换字节。
5. 实现 MediaRecorder Hook：跟踪输出文件路径并在 `stop()` 后覆盖为自定义视频。
6. 实现设置页：开关、模式、白名单、素材导入/路径写入与保存配置。
7. 最小验证：本地 `assembleDebug`（如环境具备），并输出设备侧验证步骤。

## 边界与风险

- v1 不保证覆盖所有 Camera2/MediaCodec/自定义编码链路。
- 若目标 App 无存储权限，可能无法读取 `/sdcard/VirtualCam/` 下素材；建议对白名单 App 授权存储权限或改用其可读路径。
