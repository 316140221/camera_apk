<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    >
    <link rel="stylesheet" href="leaflet/leaflet.css">
    <style>
      html, body {
        height: 100%;
        margin: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 64px;
        left: 0;
        right: 0;
      }
      #panel {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        background: rgba(255, 255, 255, 0.95);
        border-top: 1px solid #e0e0e0;
        font-family: sans-serif;
        font-size: 14px;
      }
      #coords {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #btn_apply {
        height: 36px;
        padding: 0 12px;
        border: none;
        border-radius: 4px;
        background: #1976d2;
        color: #fff;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="panel">
      <div id="coords">Lat: --, Lng: --</div>
      <button id="btn_apply" type="button">Use</button>
    </div>

    <script src="leaflet/leaflet.js"></script>
    <script>
      function getQueryParam(name) {
        var params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      function toNumber(value) {
        var num = parseFloat(value);
        return isNaN(num) ? null : num;
      }

      var initLat = toNumber(getQueryParam("lat"));
      var initLng = toNumber(getQueryParam("lng"));
      if (initLat === null) initLat = 0.0;
      if (initLng === null) initLng = 0.0;

      var map = L.map("map").setView([initLat, initLng], 16);
      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      var marker = L.marker([initLat, initLng]).addTo(map);
      var selected = { lat: initLat, lng: initLng };
      updateCoords(selected.lat, selected.lng);

      map.on("click", function (e) {
        selected = { lat: e.latlng.lat, lng: e.latlng.lng };
        marker.setLatLng([selected.lat, selected.lng]);
        updateCoords(selected.lat, selected.lng);
      });

      document.getElementById("btn_apply").addEventListener("click", function () {
        if (window.Android && typeof window.Android.onLocationSelected === "function") {
          window.Android.onLocationSelected(selected.lat, selected.lng);
        }
      });

      function updateCoords(lat, lng) {
        var text = "Lat: " + lat.toFixed(6) + ", Lng: " + lng.toFixed(6);
        document.getElementById("coords").textContent = text;
      }
    </script>
  </body>
</html>
